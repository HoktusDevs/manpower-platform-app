service: auth-service

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    STAGE: ${self:provider.stage}
    COGNITO_USER_POOL_ID: us-east-1_kQKPPUqRO
    COGNITO_CLIENT_ID: ${self:custom.cognitoClientId}
    SESSIONS_TABLE: ${self:custom.sessionsTable}
  iamRoleStatements:
    # Cognito permissions
    - Effect: Allow
      Action:
        - cognito-idp:AdminCreateUser
        - cognito-idp:AdminSetUserPassword
        - cognito-idp:AdminInitiateAuth
        - cognito-idp:AdminGetUser
        - cognito-idp:AdminUpdateUserAttributes
        - cognito-idp:AdminDeleteUser
        - cognito-idp:ForgotPassword
        - cognito-idp:ConfirmForgotPassword
        - cognito-idp:ConfirmSignUp
        - cognito-idp:ResendConfirmationCode
      Resource:
        - arn:aws:cognito-idp:${self:provider.region}:*:userpool/us-east-1_kQKPPUqRO
    # DynamoDB permissions
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:DeleteItem
        - dynamodb:Scan
        - dynamodb:Query
      Resource:
        - Fn::GetAtt: [SessionsTable, Arn]

custom:
  cognitoClientId: ${env:COGNITO_CLIENT_ID, '37t0pkhu9kdrf01lqqoj0e911f'}
  sessionsTable: auth-sessions-${self:provider.stage}

functions:
  # Health Check
  healthCheck:
    handler: src/handlers/health.checkHealth
    events:
      - http:
          path: /health
          method: get
          cors: true

  # Authentication
  registerAdmin:
    handler: src/handlers/auth.registerAdmin
    events:
      - http:
          path: /auth/registro/admin
          method: post
          cors: true

  registerEmployee:
    handler: src/handlers/auth.registerEmployee
    events:
      - http:
          path: /auth/registro
          method: post
          cors: true

  login:
    handler: src/handlers/auth.login
    events:
      - http:
          path: /auth/login
          method: post
          cors: true

  refreshToken:
    handler: src/handlers/auth.refreshToken
    events:
      - http:
          path: /auth/refresh
          method: post
          cors: true

  exchangeSession:
    handler: src/handlers/auth.exchangeSession
    events:
      - http:
          path: /auth/exchange-session
          method: post
          cors: true

  logout:
    handler: src/handlers/auth.logout
    events:
      - http:
          path: /auth/logout
          method: post
          cors: true

  # Password Management
  forgotPassword:
    handler: src/handlers/auth.forgotPassword
    events:
      - http:
          path: /auth/forgot-password
          method: post
          cors: true

  resetPassword:
    handler: src/handlers/auth.resetPassword
    events:
      - http:
          path: /auth/reset-password
          method: post
          cors: true

  # Email Verification
  verifyEmail:
    handler: src/handlers/auth.verifyEmail
    events:
      - http:
          path: /auth/verify-email
          method: post
          cors: true

  # Profile Management (Protected)
  getProfile:
    handler: src/handlers/auth.getProfile
    events:
      - http:
          path: /auth/profile
          method: get
          cors: true

resources:
  Resources:
    # DynamoDB Table for Sessions
    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.sessionsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

plugins:
  - serverless-plugin-typescript
  - serverless-offline